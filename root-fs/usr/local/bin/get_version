#!/usr/bin/python
import json
import sys
import urllib2

import semver

image_name = sys.argv[-1]


def version_file():
    return open('VERSION').readline().strip()


base_version = version_file()
base_ver = semver.parse_version_info(base_version)
base_major = base_ver.major
base_minor = base_ver.minor
base_patch = base_ver.patch
tag_url = 'https://hub.docker.com/v2/repositories/{}/tags'.format(image_name)

tag_json = json.load(urllib2.urlopen(tag_url))
highest_built_version = -1
for result in tag_json['results']:
    name = result['name']
    try:
        ver = semver.parse_version_info(name)
    except ValueError:
        continue
    if ver.major == base_major and ver.minor == base_minor:
        print name
        high_ver = semver.parse_version_info(semver.max_ver(base_version, name))
        highest_built_version = max(ver.patch, highest_built_version)
print highest_built_version
if highest_built_version >= base_patch:
    print semver.format_version(base_major, base_minor, highest_built_version + 1)
else:
    print semver.format_version(base_major, base_minor, base_patch)
