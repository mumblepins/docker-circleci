#!/usr/bin/env bash -ex
echo $PWD

VERSION=$( cat VERSION | sed -e 's/^[[:space:]]*//' -e 's/[[:space:]]*$//' )
GIT_COMMIT=$( git rev-parse --short HEAD )
BUILD_DATE=$( date -u +"%Y-%m-%dT%H:%M:%SZ" )
GIT_URL=$( git config --get remote.origin.url )

# Convert github ssh repo to https
if echo "$GIT_URL" | grep -q "git@github.com"; then
  GIT_URL=$( echo "$GIT_URL" | sed -r 's|git@github.com:|https://github.com/|' )
fi

echo "export VERSION=\"$VERSION\"" >> $BASH_ENV
echo "export GIT_COMMIT=\"$GIT_COMMIT\"" >> $BASH_ENV
echo "export BUILD_DATE=\"$BUILD_DATE\"" >> $BASH_ENV
echo "export GIT_URL=\"$GIT_URL\"" >> $BASH_ENV

echo -e "BASH_ENV:\n$(cat $BASH_ENV)"

